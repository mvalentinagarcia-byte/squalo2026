#include <ODriveUART.h>
#include <SoftwareSerial.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ILI9341.h>
#include <SPI.h>

// -----------------------------
// Comunicación con ODrive
// -----------------------------
SoftwareSerial odrive_serial(3, 2);  // RX, TX
unsigned long baudrate = 19200;
ODriveUART odrive(odrive_serial);

// -----------------------------
// Pines TFT (ajusta según tu conexión)
// -----------------------------
#define TFT_CS   10
#define TFT_DC    9
#define TFT_RST   8  // Puedes usar -1 si está conectado a RESET del Arduino
Adafruit_ILI9341 tft = Adafruit_ILI9341(TFT_CS, TFT_DC, TFT_RST);

// -----------------------------
// Pines y parámetros
// -----------------------------
const int FWD_PIN = 4;
const int REV_PIN = 5;
const float SPEED_NEAR_ZERO = 10;
bool direccion = 1;

const float CIRC_M = 0.66 * 3.1415926f;
// -----------------------------
// Filtro de voltaje
// -----------------------------
const int VOLTAGE_READINGS = 5;
float voltageReadings[VOLTAGE_READINGS];
int voltageIndex = 0;
float voltageTotal = 0;
float voltageAverage = 0;
unsigned long lastVoltageTime = 0;
const unsigned long VOLTAGE_READ_INTERVAL = 100;
const float MIN_VALID_VOLTAGE = 5.0;
const float MAX_VOLTAGE_CHANGE = 2.0;

unsigned long lastUpdate = 0;

const uint16_t PROGMEM img36x36[1296] = {
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x9628,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4425,0x0000,0x0000,0x0000,0x0000,0x9628,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x4425,0x4425,0x0000,0x0000,0x0000,0x9647,0x9647,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x4425,0x4425,0x4425,0x0000,0x0000,0x9628,0x9647,0x9647,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x4425,0x4425,0x4C06,0x4C06,0x0000,0x9628,0x9647,0x9647,0x9647,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x4425,0x4425,0x4425,0x4425,0x0000,0x9DEA,0x9647,0x9647,0x9647,0x9DEA,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x4425,0x4425,0x4425,0x4425,0x4425,0x9DEA,0x9647,0x9647,0x9647,0x9647,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x4425,0x4425,0x4425,0x4425,0x4425,0x7DA8,0x9628,0x9647,0x9647,0x9647,0x9647,0x0000,
0x0000,0x0000,0x4C06,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4C06,
0x4425,0x4425,0x4425,0x4425,0x2B84,0x9647,0x9647,0x9647,0x9647,0x9647,0x0000,0x0000,
0x4C06,0x4425,0x0000,0x0000,0x9DEA,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4425,0x4425,
0x4425,0x4425,0x4425,0x2B84,0x2325,0x9647,0x9647,0x9647,0x9647,0x9647,0x0000,0x0000,
0x4425,0x4425,0x0000,0x9DEA,0x9647,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4425,0x4425,0x4425,
0x4425,0x4425,0x2B84,0x2325,0x2325,0x9647,0x9647,0x9647,0x9647,0x9647,0x0000,0x4C06,
0x4425,0x4C06,0x0000,0x9647,0x9647,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4C06,0x4425,0x4425,0x4425,
0x4425,0x2B84,0x2325,0x2325,0x2B84,0x9647,0x9647,0x9647,0x9647,0x9647,0x4C06,0x4425,
0x4425,0x0000,0x9647,0x9647,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4C06,0x4425,0x4425,0x4425,0x4425,
0x2B84,0x2325,0x2325,0x2325,0x9628,0x9647,0x9647,0x9647,0x9647,0x4425,0x4425,0x4425,
0x2B84,0x9647,0x9647,0x9647,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x4C06,0x4425,0x4425,0x4425,0x4425,0x2B84,
0x2325,0x2325,0x2325,0x2325,0x9647,0x9647,0x9647,0x4425,0x4425,0x4425,0x4425,0x2B84,
0x9647,0x9647,0x9647,0x9647,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
};
const uint8_t  LOGO_SCALE = 8;
const uint32_t SPLASH_MS  = 1500;

// ===== Colores/estilo =====
const uint16_t BG     = ILI9341_BLACK;
const uint16_t SEGON  = ILI9341_GREEN;    // segmentos ON (velocímetro)
const uint16_t SEGOFF = 0x0841;           // “apagado” tenue (pon BG si no quieres verlo)
const uint16_t TXT    = ILI9341_WHITE;

// ===== 7-segmentos (sin parpadeo) =====
/* segmentos: a b c d e f g -> bit6..bit0 */
const uint8_t DIG_MASK[10] = {
  0b1111110, 0b0110000, 0b1101101, 0b1111001, 0b0110011,
  0b1011011, 0b1011111, 0b1110000, 0b1111111, 0b1111011
};
int segT(uint8_t s){ return 2*s; }                // grosor
int segL(uint8_t s){ return 10*s; }               // largo
int digitW(uint8_t s){ return segL(s)+2*segT(s);} // ancho dígito
int digitH(uint8_t s){ return 2*segL(s)+3*segT(s);} // alto dígito

void draw7SegDigit(int16_t x, int16_t y, uint8_t num, uint8_t s,
                   uint16_t colOn=SEGON, uint16_t colOff=SEGOFF){
  uint8_t m = DIG_MASK[num%10];
  int t=segT(s), L=segL(s);
  auto H=[&](int16_t xx,int16_t yy,bool on){ tft.fillRect(xx,yy,L,t,on?colOn:colOff); };
  auto V=[&](int16_t xx,int16_t yy,bool on){ tft.fillRect(xx,yy,t,L,on?colOn:colOff); };
  H(x+t,       y,            m & 0b1000000); // a
  V(x+t+L,     y+t,          m & 0b0100000); // b
  V(x+t+L,     y+t+L+t,      m & 0b0010000); // c
  H(x+t,       y+2*(t+L),    m & 0b0001000); // d
  V(x,         y+t+L+t,      m & 0b0000100); // e
  V(x,         y+t,          m & 0b0000010); // f
  H(x+t,       y+(t+L),      m & 0b0000001); // g
}
void drawDecimalPoint(int16_t x, int16_t y, uint8_t s, uint16_t col=SEGON){
  int t = segT(s); tft.fillRect(x, y, t, t, col);
}

// ===== Splash (logo escalado por bloques) =====
void drawRGB565Scaled_P(int16_t x,int16_t y,const uint16_t *bmp,int16_t w,int16_t h,uint8_t s){
  for(int16_t j=0;j<h;j++) for(int16_t i=0;i<w;i++){
    uint16_t c = pgm_read_word(&bmp[j*w+i]);
    tft.fillRect(x+i*s, y+j*s, s, s, c);
  }
}

// ===== Tripleta inferior (Dist, Vbat, Power) =====
struct Cell { const char* label; String prev; };
Cell cells[3] = { {"Dist", ""}, {"Vbat", ""}, {"Power", ""} };

void drawBottomCellsFrame(){
  int16_t top = tft.height() - 70;
  tft.fillRect(0, top, tft.width(), 70, BG);
  int colW = tft.width()/3;
  for(int i=0;i<3;i++){
    int x0 = i*colW;
    tft.setTextColor(SEGON, BG); tft.setTextSize(1);
    int16_t bx,by; uint16_t bw,bh;
    tft.getTextBounds(cells[i].label,0,0,&bx,&by,&bw,&bh);
    tft.setCursor(x0 + (colW-bw)/2, top + 6);
    tft.print(cells[i].label);
  }
}
void updateCell(int idx, const String& value){
  int16_t top = tft.height() - 70;
  int colW = tft.width()/3;
  if(value == cells[idx].prev) return;
  cells[idx].prev = value;
  int x0 = idx*colW;
  tft.setTextColor(TXT, BG); tft.setTextSize(2);
  tft.fillRect(x0+4, top+24, colW-8, 40, BG);
  int16_t bx,by; uint16_t bw,bh;
  tft.getTextBounds(value,0,0,&bx,&by,&bw,&bh);
  tft.setCursor(x0 + (colW-bw)/2, top + 28);
  tft.print(value);
}

// ===== Velocímetro 0..30.0 km/h con 1 decimal (sin parpadeo) =====
void drawSpeedDecimal(float v_kmh, uint8_t s, int16_t topY){
  if(v_kmh < 0) v_kmh = 0;
  if(v_kmh > 50.0f) v_kmh = 50.0f;

  static int last_tens=-1, last_units=-1, last_tenths=-1;
  int v10   = (int)roundf(v_kmh*10.0f);
  int tens  = (v10/10)/10;       // 0..3
  int units = (v10/10)%10;       // 0..9
  int tenths= v10%10;            // 0..9

  int w=digitW(s), sp=2*s, t=segT(s);
  int totalW = 3*w + 2*sp + t;   // 2 dígitos + punto + 1 dígito
  int16_t x = (tft.width()-totalW)/2;
  int16_t y = topY;

  if(tens  != last_tens ) { draw7SegDigit(x, y, tens,  s); last_tens  = tens;  }
  x += w + sp;
  if(units != last_units){ draw7SegDigit(x, y, units, s); last_units = units; }
  x += w + sp;
  drawDecimalPoint(x, y + digitH(s) - segT(s), s); // punto fijo
  x += t + sp;
  if(tenths!= last_tenths){ draw7SegDigit(x, y, tenths,s); last_tenths= tenths;}

  // etiqueta km/h (texto opaco → no parpadea)
  tft.setTextSize(2);
  tft.setTextColor(TXT, BG);
  String lab = "km/h";
  int16_t bx,by; uint16_t bw,bh;
  tft.getTextBounds(lab,0,0,&bx,&by,&bw,&bh);
  int16_t tx = (tft.width()-bw)/2;
  int16_t ty = y + digitH(s) + 2;
  tft.setCursor(tx, ty);
  tft.print(lab);
}
// ===== Estado para métricas =====
unsigned long lastTickMs = 0;
double dist_km = 0.0;
float kmh_filt = 0.0f;          // filtro para suavizar velocidad
float vbat_filt = 0.0f;
float ibus_filt = 0.0f;

inline String fmtFix(float v, uint8_t d){ char b[18]; dtostrf(v,0,d,b); return String(b); }

// -----------------------------
// Inicialización
// -----------------------------
void setup() {
  odrive_serial.begin(baudrate);
  Serial.begin(115200);

  pinMode(FWD_PIN, INPUT_PULLUP);
  pinMode(REV_PIN, INPUT_PULLUP);

  initializeVoltageFilter();

  // --- Inicializar pantalla ---
  SPI.begin();
  tft.begin();
  tft.setRotation(1); // Horizontal
    tft.fillScreen(BG);
  int16_t W=36*LOGO_SCALE, H=36*LOGO_SCALE;
  int16_t X=(tft.width()-W)/2, Y=(tft.height()-H)/2;
  drawRGB565Scaled_P(X,Y,img36x36,36,36,LOGO_SCALE);
  delay(SPLASH_MS);
  tft.fillScreen(ILI9341_BLACK);
  tft.setTextColor(ILI9341_GREEN);
  tft.setTextSize(2);

  tft.setCursor(50, 100);
  tft.print("Esperando ODrive...");

  // --- Esperar ODrive ---
  while (odrive.getState() == AXIS_STATE_UNDEFINED) {
    delay(100);
  }

  tft.fillScreen(ILI9341_BLACK);
  tft.setCursor(70, 100);
  tft.print("ODrive encontrado");
  delay(800);

  tft.fillScreen(ILI9341_BLACK);
  tft.setCursor(60, 100);
  tft.print("Habilitando motor...");

  while (odrive.getState() != AXIS_STATE_CLOSED_LOOP_CONTROL) {
    odrive.clearErrors();
    odrive.setState(AXIS_STATE_CLOSED_LOOP_CONTROL);
    delay(10);
  }

  tft.fillScreen(ILI9341_BLACK);
  tft.setCursor(80, 100);
  tft.print("ODrive listo!");
  delay(800);
  tft.fillScreen(ILI9341_BLACK);

  tft.fillScreen(BG);
  drawBottomCellsFrame();
}


// -----------------------------
// Inicializar filtro de voltaje
// -----------------------------
void initializeVoltageFilter() {
  for (int i = 0; i < VOLTAGE_READINGS; i++) voltageReadings[i] = 0;
  voltageTotal = 0;
  voltageAverage = 0;
}

// -----------------------------
// Leer voltaje filtrado
// -----------------------------
float readFilteredVoltage() {
  static float lastValidVoltage = 0;
  unsigned long currentTime = millis();
  if (currentTime - lastVoltageTime < VOLTAGE_READ_INTERVAL)
    return voltageAverage;

  lastVoltageTime = currentTime;
  float instantSum = 0;
  int validCount = 0;

  for (int i = 0; i < 3; i++) {
    float reading = odrive.getParameterAsFloat("vbus_voltage");
    if (reading >= MIN_VALID_VOLTAGE) {
      if (lastValidVoltage > 0 && fabs(reading - lastValidVoltage) > MAX_VOLTAGE_CHANGE)
        continue;
      instantSum += reading;
      validCount++;
    }
    delay(2);
  }

  if (validCount == 0) return voltageAverage;

  float instantAvg = instantSum / validCount;
  lastValidVoltage = instantAvg;

  voltageTotal = voltageTotal - voltageReadings[voltageIndex] + instantAvg;
  voltageReadings[voltageIndex] = instantAvg;
  voltageIndex = (voltageIndex + 1) % VOLTAGE_READINGS;
  voltageAverage = voltageTotal / VOLTAGE_READINGS;

  return voltageAverage;
}

// -----------------------------
// Bucle principal
// -----------------------------
void loop() {
  int potValue = analogRead(A0);
  ODriveFeedback feedback = odrive.getFeedback();
  float mappedVelocity = map(potValue, 170, 850, 0, 20);

  int fwd = digitalRead(FWD_PIN);
  int rev = digitalRead(REV_PIN);
  bool want_forward = (fwd == LOW && rev == HIGH);
  bool want_reverse = (rev == LOW && fwd == HIGH);

  float cmd = 0.0;
  if (!want_forward && !want_reverse) {
    cmd = 0.0;
  } else {
    bool target = want_forward;
    if (direccion == target) {
      cmd = direccion ? +mappedVelocity : -mappedVelocity;
    } else {
      if (fabs(feedback.vel) < SPEED_NEAR_ZERO) {
        direccion = target;
        cmd = direccion ? +mappedVelocity : -mappedVelocity;
      } else {
        cmd = 0.0;
      }
    }
  }

  odrive.setVelocity(cmd);
  float currentVoltage = readFilteredVoltage();
    // ======== Cálculos para UI ========
  // vel rueda en m/s desde turns/s de motor
  float wheel_tps = feedback.vel;
  float mps       = wheel_tps * CIRC_M;
  float kmh       = mps * 3.6f;

  // filtro exponencial (suaviza sin lag excesivo)
  const float alpha = 0.25f;  // 0..1 (más alto = menos suavizado)
  kmh_filt = kmh_filt + alpha*(kmh - kmh_filt);

  // integrar distancia
  unsigned long now = millis();
  float dt = (now - lastTickMs)/1000.0f; lastTickMs = now;
  if(dt > 0 && dt < 0.5f) dist_km += (kmh_filt/3600.0f)*dt;

  // medir V e I del bus (si I no existe en tu FW, quedará ~0)
  float vbus = odrive.getParameterAsFloat("vbus_voltage");
  float ibus = odrive.getParameterAsFloat("ibus"); // prueba "ibus_filtered" si tu FW lo soporta

  // Actualizar pantalla cada 100 ms
  if (millis() - lastUpdate > 50) {
    lastUpdate = millis();
    drawSpeedDecimal(kmh_filt, /*scale*/4, /*topY*/8);

    //tft.fillScreen(ILI9341_BLACK);

    /*tft.setCursor(40, 40);
    tft.print("Velocidad:  ");
    tft.print(feedback.vel, 1);
    tft.print(" rpm");

    tft.setCursor(40, 80);
    tft.print("Objetivo:   ");
    tft.print(mappedVelocity, 1);
    tft.print(" rpm");

    tft.setCursor(40, 120);
    tft.print("Comando:    ");
    tft.print(cmd, 1);
    tft.print(" rpm");

    tft.setCursor(40, 160);
    tft.print("Voltaje:    ");
    tft.print(currentVoltage, 1);
    tft.print(" V");*/
    updateCell(0, fmtFix(dist_km, 2) + " km");
    updateCell(1, fmtFix(vbus, 1) + " V");
    // si ibus no está disponible, esto mostrará 0 W; puedes cambiar por "— W" si prefieres
    updateCell(2, fmtFix(ibus, 0) + " W");
  }
}
